<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="application.css">
  <title>APPLICATION</title>
  <style>
  
  </style>
</head>
<body>
  <h1>
    ADMISSIONS
  </h1>
 <select id="sessionSelect">
    <option value=""> -select session- </option>
  </select>
  <!--4select>
    <option> -select term- </option>
    <option>1<sup>st</sup> term</option>
    <option>2<sup>nd</sup> term</option>
    <option>3<sup>rd</sup> term</option>
  </select-->

  <!--a href="#">View all</a-->
  
  <table>
    <tr>
      <th>A/N</th>
      <th>Name</th>
      <th>Class</th>
      <th>House</th>
      <th>Admission Letter</th>
      <th>Action</th>
    </tr>
      <tbody id="table">
          
      </tbody>
  </table>
 

 
  <!--button id="batchPrint">Batch Print</button-->


    <!--button id="printBtn">download</button-->
  <script src="config.js"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, doc, query, where, setDoc, getDoc} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
     // import {getDatabase, set, ref, onValue, child, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    
    
    const schoolId = "almadeenah";
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
    const db = getFirestore(app);
    
        
    const terms = ["first term", "second term", "third term"];

    let sectionRef = doc(db, schoolId, "section");
  var classes = [];
  const houses = ["Red", "Green", "Blue", "Yellow"]; 
let sectionDoc = await getDoc(sectionRef);
 if (sectionDoc.exists()){
   let sections = sectionDoc.data();
   let keys = Object.keys(sections);
   keys.forEach(key=>{
     let cls = sections[key].classes;
     classes = classes.concat(cls);
     console.log(classes);
   });

 }
  
  
  let sessionsRef = doc(db, schoolId, "sessions");
  //let studentsRef = doc(db, schoolId, "classes");
  let sessionsDoc = await getDoc(sessionsRef);
  if (sessionsDoc.exists()){
    let sessions =  sessionsDoc.data().sessions;
     sessions= sessions.sort((a, b)=>b.no - a.no);
    sessions.forEach((session, i)=>{
        let year = session.year;
      let opt = document.createElement("option");
      opt.innerHTML = year + ", " + terms[session.term];
      opt.dataset.year = year.replace("/", "_");
      opt.dataset.term = session.term;
      sessionSelect.appendChild(opt);
        if (i==0)
        opt.selected = true;
    });
    console.log(JSON.stringify(sessions[0]));
    loadApps({term:sessions[0].term, year:sessions[0].year.replace("/", "_")});
      //sessionSelect.firstChild.nextElementSibling.selected = true;
  }
  
  

  
  

  async function loadApps(session){
 
    console.log(session);
    console.log(`year${session.year}term${session.term}`);
    let ref = doc(db, schoolId, "db", "applications", `year${session.year}term${session.term}`);
    if (session){
      //let q = query(collection(db, schoolId, "db", "applications"), where("year", "==", session.year), where("term", session.term));
      
      let appDoc = await getDoc(ref);
      let apps;
      if (appDoc.exists()) apps = appDoc.data();
      else apps = {
        applicants : [],
        year: session.year,
        term: session.term
      }
      renderApplications(apps);
      
 
      }
      
  
      
    function renderApplications(apps){
      table.innerHTML = "";
      let params = new URLSearchParams(window.location.search);
      let id = params.get("an"); 
      apps.applicants.forEach(app => {
        if (app.status != "admitted") return;
        if (id && !(app.an==id)) return;
        let row = table.insertRow();
    
    // A/N
        let anCell = row.insertCell();
        anCell.innerText = app.an;
        anCell.setAttribute("data-label", "A/N");
        anCell.className = "an";

    // Name
        let nameCell = row.insertCell();
        nameCell.textContent = app.name;
        nameCell.setAttribute("data-label", "Name");

    // Class
       let clsCell = row.insertCell();
       clsCell.innerHTML = `${app.class}`;
       clsCell.setAttribute("data-label", "Class");

    // House
    let houseCell = row.insertCell();
    houseCell.innerHTML = `${app.house}`;   
    houseCell.setAttribute("data-label", "House");

    // Action
    let statusCell = row.insertCell();    
      let admitBtn = document.createElement("button");
      admitBtn.textContent = "Print";
      statusCell.append(admitBtn);   
      admitBtn.className = "print-btn";
        admitBtn.onclick = e=>{
          let params = `
          ?an=${app.an}&name=${app.name}&class=${app.class}&house=${app.house}&date=${app.admissionDate}&session=${apps.year}
          `.trim();
          window.location.href = `letter.html${params}`      
        }
    statusCell.setAttribute("data-label", "Admission Letter");
        
        
            
     // register
    let registerCell = row.insertCell();
    registerCell.innerHTML = `${app.registered? "Registered" : "<button>register</button>"}`;   
    registerCell.setAttribute("data-label", "Action");
    let regBtn = registerCell.querySelector("button");
    if (regBtn){
      regBtn.onclick = e=>{
        localStorage.setItem("registrant", JSON.stringify(app));
        window.location.href="../student/registration.html";
      }
    }        

  });

    }
  }
  
  
  
    sessionSelect.onchange = async e=>{
      table.innerHTML = "";
      if (sessionSelect.value){
        let i = sessionSelect.selectedIndex;
        let selected = sessionSelect.children[i];
        let session = {
          year: selected.dataset.year,
          term: selected.dataset.term
        }
        console.log(JSON.stringify(session));
        loadApps(session);
      }
  }
    
 
  
  function key(token){
    return token.replaceAll(" ","").replaceAll("/", "").replaceAll(",", "").trim();
  }
 

  function getContrastingColor(bgColor) {
  // Map named colors to RGB
  const colors = {
    red: [255, 0, 0],
    green: [0, 128, 0],
    blue: [0, 0, 255],
    yellow: [255, 255, 0]
  };

  const rgb = colors[bgColor.toLowerCase()];
  if (!rgb) throw new Error("Unsupported color");

  // Formula for relative luminance
  const [r, g, b] = rgb.map(c => {
    c /= 255;
    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
  });

  const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;

  // Use white if dark background, black if light background
  return luminance > 0.179 ? "black" : "white";
}

// Example usage:
/*console.log(getContrastingTextColor("red"));    // white
console.log(getContrastingTextColor("green"));  // white
console.log(getContrastingTextColor("blue"));   // white
console.log(getContrastingTextColor("yellow")); // black
  */
  </script>
</body>
</html>
